<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>カード登録</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    .card-item {
      background: white;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
    }
    .name { font-weight: bold; font-size: 18px; }
    .btn {
      background: black;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover { opacity: 0.85; }
    .section-title { margin-top: 24px; font-size: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h2>カード登録</h2>

    <h3 class="section-title">既存カード一覧（cards.json）</h3>
    <div id="existingCards"></div>

    <h3 class="section-title">手動カード登録</h3>
    <form id="manualForm">
      <label>ID: <input type="text" id="m_id" required /></label><br>
      <label>名前: <input type="text" id="m_name" required /></label><br>
      <label>ランク: 
        <select id="m_rank">
          <option value="normal">normal</option>
          <option value="gold">gold</option>
          <option value="platinum">platinum</option>
        </select>
      </label><br>
      <label>通常還元率(%): <input type="number" id="m_base" required /></label><br>
      <label>公式URL: <input type="url" id="m_url" /></label><br>

      <div>
        <strong>特別還元</strong>
        <div id="specialRates"></div>
        <button type="button" onclick="addSpecialRate()">＋特典を追加</button>
      </div>

      <button type="submit" class="btn">手動カードを登録</button>
    </form>

    <button class="btn" style="margin-top:20px" onclick="location.href='index.html'">戻る</button>
  </div>

<script>
const CARD_DATA_URL = "./card_data/cards.json";

function getLocal() {
  return JSON.parse(localStorage.getItem("owned_cards") || "[]");
}

function setLocal(data) {
  localStorage.setItem("owned_cards", JSON.stringify(data));
}

async function loadExistingCards() {
  try {
    const res = await fetch(CARD_DATA_URL);
    const json = await res.json();
    renderExisting(json.cards);
  } catch(e) {
    console.error(e);
  }
}

function renderExisting(cards) {
  const owned = getLocal();
  const container = document.getElementById("existingCards");
  container.innerHTML = "";

  cards.forEach(card => {
    const isOwned = owned.includes(card.id);
    const div = document.createElement("div");
    div.className = "card-item";

    const specials = card.special_rates?.map(s => `・${s.store}（${s.condition}）：${s.rate}%`).join("<br>") ?? "特典なし";

    div.innerHTML = `
      <div class="name">${card.name}</div>
      <div>ランク：${card.rank}</div>
      <div>通常還元率：${card.base_rate}%</div>
      <div>特別還元：<br>${specials}</div>
      <a href="${card.url}" target="_blank">公式サイト</a><br><br>
      <button class="btn" ${isOwned ? "disabled" : ""} onclick="addExisting('${card.id}')">
        ${isOwned ? "登録済" : "追加"}
      </button>
    `;

    container.appendChild(div);
  });
}

function addExisting(id) {
  const owned = getLocal();
  if (!owned.includes(id)) {
    owned.push(id);
    setLocal(owned);
    loadExistingCards();
  }
}

let specialIndex = 0;
function addSpecialRate() {
  const wrap = document.getElementById("specialRates");
  const div = document.createElement("div");
  div.innerHTML = `
    <label>店: <input type="text" id="s_store_${specialIndex}" required></label>
    <label>条件: <input type="text" id="s_cond_${specialIndex}" required></label>
    <label>還元率(%): <input type="number" id="s_rate_${specialIndex}" required></label>
    <br>
  `;
  wrap.appendChild(div);
  specialIndex++;
}

// 手動登録
const manualForm = document.getElementById("manualForm");
manualForm.addEventListener("submit", (e) => {
  e.preventDefault();

  let owned = getLocal();
  let manual = JSON.parse(localStorage.getItem("manual_cards") || "[]");
  if (manual.length >= 3) {
    alert("手動登録は3枚までです");
    return;
  }

  const m = {
    id: document.getElementById("m_id").value,
    name: document.getElementById("m_name").value,
    rank: document.getElementById("m_rank").value,
    base_rate: Number(document.getElementById("m_base").value),
    url: document.getElementById("m_url").value,
    special_rates: []
  };

  for(let i = 0; i < specialIndex; i++){
    const sStore = document.getElementById(`s_store_${i}`);
    if(!sStore) continue;
    m.special_rates.push({
      store: sStore.value,
      condition: document.getElementById(`s_cond_${i}`).value,
      rate: Number(document.getElementById(`s_rate_${i}`).value)
    });
  }

  manual.push(m);
  localStorage.setItem("manual_cards", JSON.stringify(manual));

  owned.push(m.id);
  setLocal(owned);

  alert("登録しました");
  manualForm.reset();
});

loadExistingCards();
</script>
</body>
</html>
